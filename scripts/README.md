# PRM_4_113603 :: scripts

Below is an illustration of the MLOps workflow in terms of the Generate+ETL (GETL) framework used in **Phys. Rev. Materials 4, 113603** (DOI: https://doi.org/10.1103/PhysRevMaterials.4.113603; or the [preprint](https://www.researchgate.net/publication/345634787_Chemical_bonding_in_metallic_glasses_from_machine_learning_and_crystal_orbital_Hamilton_population)):

![MLOPs workflow used in PRM_4_113603](../img/PRM_4_113603_MLOps.drawio.png)

Below a description of the directories in this folder in the order they are used in the MLOps workflow depicted in the diagram above:

## Generate (DataOps phase)

üìù **NOTE**: The original folder structure of the **raw data sources** generated using CMD simulations is

**ML/big-data-full/\<NC>/c/md/lammps/100/<ID_RUN>/2000/<SUB_RUN>/**; with:

- **\<NC>**: a nominal composition (NC) of the metallic glass. All files in the folder üóÇÔ∏è [**data_examples**](https://github.com/aryrfjr/PRM_4_113603/tree/main/data_examples) are for the NC Zr‚ÇÑ‚ÇâCu‚ÇÑ‚ÇâAl‚ÇÇ.
  
- **<ID_RUN>**: an independent CMD simulation configured to start with a random distribution of 100 atoms in a cubic cell. All files in the folder üóÇÔ∏è [**data_examples**](https://github.com/aryrfjr/PRM_4_113603/tree/main/data_examples) are for run **21** of the NC Zr‚ÇÑ‚ÇâCu‚ÇÑ‚ÇâAl‚ÇÇ.

- **<SUB_RUN>**: an execution of the DFT simulations for the corresponding 100-atom cell generated with the CMD simulation (the reference structure for a specific **<ID_RUN>**). The structure used in sub-run **0** is exactly the same reference structure, whereas the remaining sub-runs (from **1** to **14**) are those derived from geometric transformations (shear, tension, compression) applied to the reference structure for **data augmentation**.

Next, a description of each script in the **Generate** step:

- üìÑ [**G/ML/big-data-full/zca-bd-full-SD-cpu.sh**](https://github.com/aryrfjr/PRM_4_113603/blob/main/scripts/G/ML/big-data-full/zca-bd-full-SD-cpu.sh): this script has no input files and it creates the run (**<ID_RUN>**) directories. For each **<ID_RUN>**, the script also creates the input file for the classical molecular dynamics (CMD) simulation using LAMMPS and then runs it. The outputs of that simulation are written to that same **<ID_RUN>** directory. The full set of files generated is:
  
  - üíæ [**Zr49Cu49Al2.lmp.inp**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/Zr49Cu49Al2.lmp.inp): LAMMPS input file with 100-atom cells and instruction to generate random atomic coordinates when the CMD simulation starts.
  
  - üíæ [**Zr49Cu49Al2.lmp.out**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/Zr49Cu49Al2.lmp.out): generated by LAMMPS.
    
  - üíæ [**log.lammps**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/log.lammps): generated by LAMMPS.
 
  - üíæ [**zca-th300.dump**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/zca-th300.dump): generated by LAMMPS.
 
  - üíæ [**ZrCuAl-2011.lammps.eam**](https://github.com/aryrfjr/PRM_4_113603/blob/main/atomistic_models/ML/big-data-full/ZrCuAl-2011.lammps.eam): copied by LAMMPS from the path in the folder üóÇÔ∏è [**atomistic_models**](https://github.com/aryrfjr/PRM_4_113603/tree/main/atomistic_models).

- üìÑ [**G/ML/big-data-full/scripts/setup_ICOHP_jobs.py**](https://github.com/aryrfjr/PRM_4_113603/blob/main/scripts/G/ML/big-data-full/scripts/setup_ICOHP_jobs.py): this script reads the output üì• [**zca-th300.dump**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/zca-th300.dump) above and:

   - Creates the directories from **0** to **14** for each **<SUB_RUN>** with:
 
     - üíæ [**Zr49Cu49Al2.scf.in**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/Zr49Cu49Al2.scf.in): Quantum ESPRESSO (QE) input file for the ground state electronic structure simulation with DFT.
    
     - üíæ [**Zr49Cu49Al2-check.scf.in**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/Zr49Cu49Al2-check.scf.in): same content of üíæ [**Zr49Cu49Al2.scf.in**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/Zr49Cu49Al2.scf.in), but it was used just to test a specific input variable of QE.
    
     - üíæ [**Zr49Cu49Al2.xyz**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/Zr49Cu49Al2.xyz): just the same atomic positions and cell vectors from the loaded file üì• [**zca-th300.dump**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/zca-th300.dump) above.
    
     - üíæ [**lobsterin**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/lobsterin): a LOBSTER input file with automatic detection of bonds.
    
     - üíæ [**lobsterin-quippy**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/lobsterin-quippy): a LOBSTER input file with pre-fixed definition of bonds.

   - Uses QUIP for **feature engineering** by computing the **feature vectors** for the ML model (SOAP descriptors) for each **<SUB_RUN>** and saves as:
 
     - üíæ [**SOAPS.vec**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2-SOAPS/c/md/lammps/100/21/2000/0/SOAPS.vec): a file with the per-atom SOAPs and the respective central atoms indexes.
    
       - ‚ö†Ô∏è **NOTE**: saved in **ML/big-data-full/\<NC>-SOAPS/c/md/lammps/100/<ID_RUN>/2000/<SUB_RUN>/**.
    
- üìÑ [**G/ML/big-data-full/zca-QE-SD_cpu.sh**](https://github.com/aryrfjr/PRM_4_113603/blob/main/scripts/G/ML/big-data-full/zca-QE-SD_cpu.sh): this script simply runs QE, what will result in the following files for each **<SUB_RUN>**:

  - üíæ [**Zr49Cu49Al2.scf.out**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/Zr49Cu49Al2.scf.out): generated by QE.
 
  - üíæ **QE_run**: the file is empty according to the script and it is used as a flag in next steps.
 
- üìÑ [**G/ML/big-data-full/zca-LOB-SD_cpu.sh**](https://github.com/aryrfjr/PRM_4_113603/blob/main/scripts/G/ML/big-data-full/zca-LOB-SD_cpu.sh): this script simply runs LOBSTER, what will result in the following files for each **<SUB_RUN>**:

  - üíæ [**Zr49Cu49Al2.lb.out**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/Zr49Cu49Al2.lb.out): generated by LOBSTER.
 
  - üíæ [**lobsterout**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/lobsterout): generated by LOBSTER and contains some information of the run. This file is not used by the ML model.
 
  - üíæ [**ICOHPLIST.lobster**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/ICOHPLIST.lobster): generated by LOBSTER and it contains the -ICOHP values (the **supervised labels**; **labeling strategy**) used to train the ML model.
 
  - üíæ [**LOB_run**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/LOB_run): the file contains the **<SUB_RUN>** according to the script and it is used as a flag in next steps.

## ETL model (ModelOps phase)

At this point the **Generate (DataOps phase)** is finished and the **ETL model (ModelOps phase)** starts. We have **automated/reproducible generated raw data** from atomistic simulations with DFT (the **bond strengths**; the **target variable** for the ML model) and **feature engineering** generated with QUIP (the SOAP descriptors; the **feature vectors** for the ML model). The next step will be the execution of the following script:

- üìÑ [**ETL_model/ML/big-data-full/scripts/create_SSDB.py**](https://github.com/aryrfjr/PRM_4_113603/blob/main/scripts/ETL_model/ML/big-data-full/scripts/create_SSDB.py): when executed in **per-bond** database mode (PB) for a given **\<NC>** it will:

  - read from all **<RUN>** and **<SUB_RUN>** folders the files:
 
    - üì• [**SOAPS.vec**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2-SOAPS/c/md/lammps/100/21/2000/0/SOAPS.vec): to load the 100-atom cells SOAP descriptors.
   
    - üì• [**Zr49Cu49Al2.scf.out**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/Zr49Cu49Al2.scf.out): just to check if the QE electronic structure calculation has converged.
   
    - üì• [**Zr49Cu49Al2.lb.out**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/Zr49Cu49Al2.lb.out): just to check if the LOBSTER calculation has been finished successfully.
   
    - üì• [**ICOHPLIST.lobster**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/G/ML/big-data-full/Zr49Cu49Al2/c/md/lammps/100/21/2000/0/ICOHPLIST.lobster): to load the **bond strengths**.
   
  - write to a **per-bond single SOAP database** (PBSSDB) directory **ML/big-data-full/\<NC>-PBSSDB** files for all possible **bond-types SA-SB** (with **SA/SB** as Zr, Al, Cu):
 
    - üíæ [**SA-SB.bnd**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/Al-Al.bnd): the result of the **labeling process**, with bonds distances and -ICOHP values (**supervised labels**). This output file header structure is composed by the columns **<RUN>**, **<SUB_RUN>**, **<ATOMA_IDX>**, **<ATOMB_IDX>**, **<BOND_DISTANCE>**, and **<BOND_ICOHP>**.
   
    - üíæ [**SA-SB-SOAPS.vec**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/Al-Al-SOAPS.vec): the SOAP vectors for atoms in bonds (the additional **feature input**).
   
    - üíæ [**DUB.info**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/DUB.info): an information file with those bonds detected by LOBSTER and by QUIP are not compatible. This output file header structure is composed by the columns **<RUN>**, **<SUB_RUN>**, and **bond**.
   
    - üíæ [**ND.info**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/ND.info): an information file with those sub-runs (**\<SUB_RUN>**) whose statuses are different from **DONE** or **SCF_CONVERGED_LOB_NOT_FINISHED_BUT_ICOHP_OK**. This output file header structure is composed by the columns **<RUN>**, **<SUB_RUN>**, and **status**.

The goal of the next step is to bring **transferability** and **model generalization** by mixing the per-NC databases. That process would be equivalent to a **feature store curation** or **training data registry**; a core asset in scalable MLOps. This is done with the following script:

- üìÑ [**ETL_model/ML/big-data-full/scripts/mix_SSDBs.py**](https://github.com/aryrfjr/PRM_4_113603/blob/main/scripts/ETL_model/ML/big-data-full/scripts/mix_SSDBs.py): this script creates **per-bond type** (two types of atoms **SA-SB**; with **SA/SB** as Zr, Al, Cu) **mixed databases** for a set of NCs with a specific number of bonds (the **training set size** in **Fig. 1** of **Phys. Rev. Materials 4, 113603**). When executed the script will:

  - read from the PBSSDB directories of the selected NCs (**ML/big-data-full/\<NC>-PBSSDB**):
 
    - üì• [**SA-SB.bnd**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/Al-Al.bnd): the result of the **labeling process**, with bonds distances and -ICOHP values (**supervised labels**). This output file header structure is composed by the columns **<RUN>**, **<SUB_RUN>**, **<ATOMA_IDX>**, **<ATOMB_IDX>**, **<BOND_DISTANCE>**, and **<BOND_ICOHP>**
   
    - üì• [**SA-SB-SOAPS.vec**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/Al-Al-SOAPS.vec): the SOAP vectors for atoms in bonds (the additional **feature input**).
   
  - write the **mixed database** (for instance named as [**DB8**](https://github.com/aryrfjr/PRM_4_113603/tree/main/data_examples/ETL_model/ML/big-data-full/DB8)):
 
    - üíæ [**DB8_SA-SB.info**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/DB8/DB8_Al-Al.info): an information file with the **mixed database** name, its **bond type**, and the number of bonds from each NC.
   
    - üíæ [**DB8_SA-SB.bnd**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/DB8/DB8_Al-Al.bnd): a file with the same structure of the per-NC file üì• [**SA-SB.bnd**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/Al-Al.bnd) from which a set of lines are randomly selected.
   
    - üíæ [**DB8_SA-SB-SOAPS.vec**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/DB8/DB8_Al-Al-SOAPS.vec): a file with the same structure of the per-NC file üì• [**SA-SB-SOAPS.vec**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/Al-Al-SOAPS.vec) from which the corresponding random lines selected for üíæ [**DB8_SA-SB.bnd**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/DB8/DB8_Al-Al.bnd) are picked.

## Train/Tune (observability or model evaluation in the ModelOps phase)

- üìÑ [**TT/ML/big-data-full/scripts/PBSSDB-kernel_fit.py**](https://github.com/aryrfjr/PRM_4_113603/blob/main/scripts/TT/ML/big-data-full/scripts/PBSSDB-kernel_fit.py): this script will load both the **training set** and the **testing set** from one or more PBSSDB directories. It can perform a cross-validation in which the training and the testing sets come from different databases or load both sets from a single database. The script will:

  - read from one or more PBSSDB directories:
 
    - üì• [**SA-SB.bnd**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/Al-Al.bnd): the result of the **labeling process**, with bonds distances and -ICOHP values (**supervised labels**). This output file header structure is composed by the columns **<RUN>**, **<SUB_RUN>**, **<ATOMA_IDX>**, **<ATOMB_IDX>**, **<BOND_DISTANCE>**, and **<BOND_ICOHP>**
   
    - üì• [**SA-SB-SOAPS.vec**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/ETL_model/ML/big-data-full/Zr49Cu49Al2-PBSSDB/Al-Al-SOAPS.vec): the SOAP vectors for atoms in bonds (the additional **feature input**).
   
  - if, for instance, the scripts runs with the NC set to **Zr49Cu49Al2**, the **interaction type** set to **Zr-Cu**, the **kernel dimension** set to **2000**, the **zeta hyperparameter** set to **1.0**, the **sigma hyperparameter** set to **1.0**, the **additional hyperparameter parameter** (see **Phys. Rev. Materials 4, 113603**) set to **0.04**, and the **training set** size set to **1000**, the following files will be generated:
 
    - üíæ [**Zr49Cu49Al2-Zr-Cu-2000-1.0-1.0-0.04-1000.dat**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/TT/ML/big-data-full/scripts/Zr49Cu49Al2_ultimate/Zr49Cu49Al2-Zr-Cu-2000-1.0-1.0-0.04-1000.dat): a two columns file with the predicted -ICOHP value from the ML model versus the actual value from DFT electronic structure simulation.
   
    - üíæ [**Zr49Cu49Al2-Zr-Cu-2000-1.0-1.0-0.04-1000.info**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/TT/ML/big-data-full/scripts/Zr49Cu49Al2_ultimate/Zr49Cu49Al2-Zr-Cu-2000-1.0-1.0-0.04-1000.info): the same content of the **.dat** file described above but with two additional columns with the indexes of the interaction in the database. And in the last four lines of the file also brings the Root Mean Square Error (RMSE) value, plus the associated variances and standard deviations for both **training** and **testing sets**.
   
    - üíæ [**Zr49Cu49Al2-Zr-Cu-2000-1.0-1.0-0.04-1000.png**](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/TT/ML/big-data-full/scripts/Zr49Cu49Al2_ultimate/Zr49Cu49Al2-Zr-Cu-2000-1.0-1.0-0.04-1000.png): a **.png** file is generated using üì¶ **matplotlib.pyplot** with all the information in the **.dat** file described above.
   
      - üìà The example of **.png** file described above is: ![example_TT_RMS_png](https://github.com/aryrfjr/PRM_4_113603/blob/main/data_examples/TT/ML/big-data-full/scripts/Zr49Cu49Al2_ultimate/Zr49Cu49Al2-Zr-Cu-2000-1.0-1.0-0.04-1000.png)
 
- üìÑ [**TT/SS-ML/scripts/ML-ICOHP_RMSD.py**](https://github.com/aryrfjr/PRM_4_113603/blob/main/scripts/TT/SS-ML/scripts/ML-ICOHP_RMSD.py): Next, the script ML-ICOHP_RMSD.py, performs a similar test to PBSSDB-kernel_fit.py, but the testing set are bonds loaded from a 100-atoms cell created in the Generate step.

## ETL inference (after Deployment/Production)

- üìÑ [**ETL_inference/SS-ML/scripts/ML-ICOHP.py**](https://github.com/aryrfjr/PRM_4_113603/blob/main/scripts/ETL_inference/SS-ML/scripts/ML-ICOHP.py): And lastly the script ML-ICOHP.py (Deployment/Production step): this is a script that reads a set of steps from a LAMMPS .dump file to compute the ML predicted -ICOHP values for all detected bonds. It uses a production mixed per-bond single SOAP database directory and trained models to infer bond strengths on large 10k-atom MG structures.
